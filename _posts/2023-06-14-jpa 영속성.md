---
title: 영속성 (가벼운 정리)
date: 2023-06-14 10:00:00 +0900
categories: [개인프로젝트]
tags: [study,jpa]     # TAG names should always be lowercase
published: false
---
영속성 컨텍스트란? 데이터베이스 사이에서 객체를 보관하는 가상의 데이터베이스 같은 역할 

1. 비영속**(new/transient)** : 객체를 생성만
2. 영속**(managed)** : 영속성 커텍스트에 엔티티를 저장
3. 준영속(**detached**) : 영속 상태 엔티티를 더이상 관리 하지 않을 때
4. 삭제(**removed**) : 엔티티를 영속성 컨텍스트와 데이터베이스에서 삭제

 

- 엔티티를 식별자 값으로 구분한다. 따라서 영속 상태는 식별자 값이 반드시 있어야 한다.
- jpa는 보통 트랜잭션을 커밋하는 순간 영속성 컨텍스트에 새로 저장된 엔티티를 데이터 베이스에 반영하는데 이를 flush라고 한다.
- 영속성 컨텍스트가 엔티티 관리할 때 장점
    - 1차 캐시 :
        - 영속성 컨텍스트 내부에는 캐시가 있는데 이를 1차 캐시라고 한다. 영속 상태의 엔티티를 이곳에 저장한다.
        - 1차 캐시의 키는 식별자 값(데이터베이스의 기본 키)이고 값은 엔티티 인스턴스이다.
        - 조회의 흐름은 다음과 같다.
            - 1차 캐시에서 엔티티를 찾는다.
            - 있으면 메모리에 이는 1차 캐시에서 엔티티를 조회한다.
            - 없으면 데이터베이스에서 조회한다.
            - 조회한 데이터로 엔티티를 생성해 1차 캐시에 저장
            - 조회한 엔티티를 반환
    - 쓰기 지연
        - 엔티티 매니저는 트랜잭션을 커밋하기 직전까지 내부 쿼리 저장소에 INSERT SQL을 모아둔다. 그리고 트랜잭션을 커밋할 때 모아둔 쿼리를 DB에 보낸다. 이것을 트랜잭션을 지원하는 쓰기 지연이라 한다.
    - 변경감지
        - jpa로 엔티티를 수정할 때는 단순히 엔티티를 조회해서 데이터를 변경하면 된다.
- 엔티티 매니저 ↔ JpaRepository
    
    ⇒ JpaRepository의 구현체 내부에서 EntityManager가 사용